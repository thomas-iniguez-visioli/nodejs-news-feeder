# Design Document - CVE Import

## Overview

Cette fonctionnalité ajoute la capacité d'importer automatiquement toutes les CVE (Common Vulnerabilities and Exposures) depuis l'API publique NVD (National Vulnerability Database) du NIST et de les intégrer dans le flux RSS existant. Le système suivra le même pattern architectural que les autres scripts de collection (issues, releases, discussions) pour maintenir la cohérence du code.

L'API NVD 2.0 sera utilisée comme source de données principale. Elle fournit un accès REST aux données CVE avec support de la pagination, du filtrage par date, et ne nécessite pas d'authentification obligatoire (bien qu'une clé API soit recommandée pour des limites de taux plus élevées).

## Architecture

### Composants Principaux

1. **CVE Collection Script** (`scripts/collect-cves.js`)
   - Script principal qui orchestre la collecte des CVE
   - Suit le pattern des autres scripts de collection existants
   - Utilise les fonctions utilitaires de `utils/index.js`

2. **NVD API Client**
   - Gère les requêtes HTTP vers l'API NVD 2.0
   - Implémente la gestion de la pagination
   - Respecte les limites de taux (rate limiting)

3. **CVE Data Processor**
   - Transforme les données brutes de l'API en format interne
   - Extrait les informations pertinentes (ID, description, score CVSS, dates)
   - Filtre les CVE selon la configuration

4. **Feed Composer**
   - Utilise les fonctions existantes (`composeFeedItem`, `getFeedContent`, `overwriteFeedContent`)
   - Formate les CVE en entrées RSS valides
   - Intègre les nouvelles entrées dans le flux existant

### Flux de Données

```
NVD API → CVE Collection Script → Data Processor → Feed Composer → feed.xml
                ↓
         Configuration (config.json)
                ↓
         lastCheckTimestamp
```

## Components and Interfaces

### 1. CVE Collection Script

**Fichier**: `scripts/collect-cves.js`

**Responsabilités**:
- Lire la configuration depuis `config.json`
- Appeler l'API NVD avec les paramètres appropriés
- Traiter les réponses et gérer la pagination
- Formater les CVE en entrées de flux
- Mettre à jour `feed.xml`

**Interface**:
```javascript
// Fonction principale (exécutée au lancement du script)
async function collectCVEs()

// Paramètres de configuration attendus dans config.json:
{
  "cve": {
    "apiEndpoint": "https://services.nvd.nist.gov/rest/json/cves/2.0",
    "resultsPerPage": 100,
    "maxResults": 500,
    "apiKey": null  // Optionnel, via process.env.NVD_API_KEY
  }
}
```

### 2. NVD API Client

**Fonctions**:

```javascript
/**
 * Récupère les CVE depuis l'API NVD
 * @param {Object} options - Options de requête
 * @param {Date} options.pubStartDate - Date de début de publication
 * @param {Date} options.pubEndDate - Date de fin de publication
 * @param {number} options.resultsPerPage - Nombre de résultats par page
 * @param {number} options.startIndex - Index de départ pour la pagination
 * @returns {Promise<Object>} - Réponse de l'API contenant les CVE
 */
async function fetchCVEs(options)

/**
 * Récupère toutes les CVE avec gestion automatique de la pagination
 * @param {Date} lastCheckTimestamp - Timestamp de la dernière vérification
 * @param {number} maxResults - Nombre maximum de CVE à récupérer
 * @returns {Promise<Array>} - Tableau de toutes les CVE récupérées
 */
async function fetchAllCVEs(lastCheckTimestamp, maxResults)
```

### 3. CVE Data Processor

**Fonctions**:

```javascript
/**
 * Extrait les informations pertinentes d'une CVE brute
 * @param {Object} cveItem - Item CVE brut de l'API NVD
 * @returns {Object} - CVE formatée avec les champs nécessaires
 */
function processCVEItem(cveItem)

/**
 * Formate une CVE en entrée de flux RSS
 * @param {Object} processedCVE - CVE traitée
 * @returns {string} - Entrée RSS formatée
 */
function formatCVEForFeed(processedCVE)
```

### 4. Configuration Extension

**Ajout à `config.json`**:

```json
{
  "cve": {
    "apiEndpoint": "https://services.nvd.nist.gov/rest/json/cves/2.0",
    "resultsPerPage": 100,
    "maxResults": 500,
    "apiKey": null,
    "minSeverity": null
  }
}
```

## Data Models

### CVE Item (API Response)

Structure des données reçues de l'API NVD 2.0:

```javascript
{
  "cve": {
    "id": "CVE-2024-XXXXX",
    "sourceIdentifier": "cve@mitre.org",
    "published": "2024-01-15T10:15:00.000",
    "lastModified": "2024-01-15T10:15:00.000",
    "vulnStatus": "Analyzed",
    "descriptions": [
      {
        "lang": "en",
        "value": "Description of the vulnerability..."
      }
    ],
    "metrics": {
      "cvssMetricV31": [
        {
          "cvssData": {
            "baseScore": 7.5,
            "baseSeverity": "HIGH"
          }
        }
      ]
    },
    "references": [
      {
        "url": "https://nvd.nist.gov/vuln/detail/CVE-2024-XXXXX",
        "source": "nvd@nist.gov"
      }
    ]
  }
}
```

### Processed CVE (Internal Format)

Format interne après traitement:

```javascript
{
  id: "CVE-2024-XXXXX",
  description: "Description of the vulnerability...",
  published: "2024-01-15T10:15:00.000",
  severity: "HIGH",
  score: 7.5,
  link: "https://nvd.nist.gov/vuln/detail/CVE-2024-XXXXX"
}
```

### Feed Item Format

Format final pour le flux RSS:

```javascript
{
  title: "CVE-2024-XXXXX: Brief description",
  description: "Full description with CVSS score and severity",
  pubDate: "Mon, 15 Jan 2024 10:15:00 GMT",
  link: "https://nvd.nist.gov/vuln/detail/CVE-2024-XXXXX",
  guid: "CVE-2024-XXXXX"
}
```


## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Complete CVE feed item formatting

*For any* CVE data received from the API, when formatted as a feed item, the result SHALL contain:
- A title including the CVE identifier
- A description with the full CVE description and CVSS score
- A link pointing to the official CVE details page
- A pubDate in RFC822 format reflecting the CVE publication date
- A unique guid based on the CVE identifier

**Validates: Requirements 1.2, 1.3, 4.1, 4.2, 4.3, 4.4, 4.5**

### Property 2: Feed integration with break delimiter

*For any* set of new CVE feed items, when appended to the existing feed content, the system SHALL use the break delimiter to separate new entries from existing ones, and the resulting feed SHALL remain valid XML.

**Validates: Requirements 1.4**

### Property 3: Complete pagination handling

*For any* API response requiring pagination, the system SHALL retrieve all available CVE pages up to the configured maximum, and no CVE SHALL be lost during the pagination process.

**Validates: Requirements 1.5, 5.2**

### Property 4: Timestamp-based filtering

*For any* configured lastCheckTimestamp, the system SHALL retrieve only CVEs with publication dates after that timestamp, and SHALL NOT include CVEs published before or at that timestamp.

**Validates: Requirements 2.4, 3.5**

### Property 5: Graceful error handling

*For any* error encountered during execution (network failures, invalid API responses, malformed CVE data), the system SHALL handle the error without corrupting the existing feed content, and SHALL continue processing remaining valid CVEs.

**Validates: Requirements 2.5, 5.4**

### Property 6: API key authentication

*For any* execution where an API key is configured via environment variable, the system SHALL include that API key in all requests to the NVD API.

**Validates: Requirements 3.2**

### Property 7: Utility function consistency

*For any* CVE formatted as a feed item, the output SHALL be identical to what would be produced by calling composeFeedItem with the same data, ensuring consistency with other collection scripts.

**Validates: Requirements 2.2**

## Error Handling

### API Errors

1. **Network Failures**
   - Retry logic avec backoff exponentiel (3 tentatives maximum)
   - Logging détaillé des erreurs réseau
   - Préservation de l'intégrité du feed existant

2. **Rate Limiting (429 responses)**
   - Respect des headers `Retry-After`
   - Délai automatique entre les requêtes (6 secondes sans clé API, 0.6 secondes avec clé)
   - Logging des événements de rate limiting

3. **Invalid API Responses**
   - Validation du format JSON
   - Vérification de la structure des données
   - Skip des entrées invalides avec logging

### Data Processing Errors

1. **Missing Required Fields**
   - Validation de la présence des champs obligatoires (id, description, published)
   - Skip des CVE incomplètes avec warning
   - Continuation du traitement des autres CVE

2. **Invalid Date Formats**
   - Tentative de parsing avec formats multiples
   - Fallback sur la date actuelle si parsing échoue
   - Logging des problèmes de format

3. **Feed Corruption Prevention**
   - Validation XML avant écriture
   - Backup du feed existant avant modification
   - Rollback en cas d'erreur d'écriture

### Configuration Errors

1. **Missing Configuration**
   - Valeurs par défaut pour tous les paramètres optionnels
   - Validation au démarrage du script
   - Messages d'erreur clairs

2. **Invalid Configuration Values**
   - Validation des types et des plages de valeurs
   - Correction automatique des valeurs invalides quand possible
   - Arrêt avec message d'erreur pour les valeurs critiques

## Testing Strategy

### Unit Testing

Le projet utilise Node.js native test runner (`node --test`). Les tests unitaires couvriront:

1. **Data Processing Functions**
   - Test de `processCVEItem` avec différentes structures de CVE
   - Test de `formatCVEForFeed` avec des données variées
   - Test des fonctions de validation

2. **Date Formatting**
   - Test de conversion des dates en RFC822
   - Test des cas limites (dates invalides, formats variés)

3. **Error Handling**
   - Test des comportements en cas d'erreur
   - Test de la préservation du feed en cas d'échec

4. **Configuration Loading**
   - Test de chargement de configuration valide
   - Test des valeurs par défaut

### Property-Based Testing

Le projet utilisera **fast-check** comme bibliothèque de property-based testing pour JavaScript/Node.js. Fast-check est mature, bien maintenu, et s'intègre parfaitement avec le test runner natif de Node.js.

**Configuration**: Chaque test property-based sera configuré pour exécuter un minimum de 100 itérations.

**Tagging**: Chaque test property-based sera tagué avec un commentaire explicite référençant la propriété du design document:
```javascript
// Feature: cve-import, Property 1: Complete CVE feed item formatting
```

Les property-based tests couvriront:

1. **Property 1: Complete CVE feed item formatting**
   - Générateur: CVE data avec variations de tous les champs
   - Vérification: Présence et format de tous les champs requis dans le feed item

2. **Property 2: Feed integration with break delimiter**
   - Générateur: Ensembles de feed items de tailles variées
   - Vérification: Validité XML et présence du break delimiter

3. **Property 3: Complete pagination handling**
   - Générateur: Réponses API paginées avec différents nombres de pages
   - Vérification: Tous les items sont collectés, aucune perte

4. **Property 4: Timestamp-based filtering**
   - Générateur: Timestamps aléatoires et ensembles de CVE avec dates variées
   - Vérification: Seules les CVE après le timestamp sont incluses

5. **Property 5: Graceful error handling**
   - Générateur: Mélanges de données valides et invalides
   - Vérification: Feed reste valide, données valides sont traitées

6. **Property 6: API key authentication**
   - Générateur: Clés API de formats variés
   - Vérification: Clé présente dans les requêtes

7. **Property 7: Utility function consistency**
   - Générateur: Données CVE variées
   - Vérification: Output identique à composeFeedItem

### Integration Testing

Tests d'intégration avec l'API NVD réelle (optionnels, marqués comme tels):

1. **Real API Calls**
   - Test avec un petit nombre de CVE réelles
   - Vérification de la structure des réponses
   - Test du rate limiting

2. **End-to-End Feed Update**
   - Test complet du script avec un feed de test
   - Vérification de l'intégrité du feed après mise à jour

## Implementation Notes

### API Rate Limiting

L'API NVD impose des limites strictes:
- **Sans clé API**: 5 requêtes par 30 secondes (délai de 6 secondes entre requêtes)
- **Avec clé API**: 50 requêtes par 30 secondes (délai de 0.6 secondes entre requêtes)

Le script devra implémenter un délai automatique entre les requêtes pour respecter ces limites.

### Pagination Strategy

L'API NVD retourne un maximum de 2000 résultats par requête. Pour gérer de grandes quantités de CVE:
1. Utiliser le paramètre `resultsPerPage` (max 2000)
2. Utiliser `startIndex` pour la pagination
3. Continuer jusqu'à ce que `totalResults` soit atteint ou `maxResults` configuré soit atteint

### CVE Description Truncation

Les descriptions de CVE peuvent être très longues. Pour le flux RSS:
- Limiter la description à 500 caractères dans le titre
- Inclure la description complète dans le corps
- Ajouter un lien vers les détails complets

### Configuration Defaults

Valeurs par défaut recommandées:
```json
{
  "cve": {
    "apiEndpoint": "https://services.nvd.nist.gov/rest/json/cves/2.0",
    "resultsPerPage": 100,
    "maxResults": 500,
    "apiKey": null,
    "minSeverity": null
  }
}
```

### Script Execution

Le script sera ajouté à `package.json`:
```json
{
  "scripts": {
    "collect:cves": "node scripts/collect-cves.js"
  }
}
```

Et pourra être intégré dans le workflow GitHub Actions existant pour l'exécution automatique.
