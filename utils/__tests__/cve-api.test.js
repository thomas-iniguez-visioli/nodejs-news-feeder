import { describe, it } from 'node:test'
import { strictEqual, ok, deepStrictEqual } from 'node:assert/strict'
import { fetchCVEs, fetchAllCVEs, processCVEItem, formatCVEForFeed } from '../cve-api.js'

describe('CVE API Client', () => {
  describe('fetchCVEs', () => {
    it('should be a function that accepts options', () => {
      // Verify the function exists and has the right signature
      ok(typeof fetchCVEs === 'function')
      strictEqual(fetchCVEs.length, 1) // Accepts 1 parameter (options object)
    })

    it('should handle date conversion for API parameters', () => {
      // Test that dates can be converted to ISO strings
      const testDate = new Date('2024-01-01T00:00:00.000Z')
      const isoString = testDate.toISOString()
      strictEqual(isoString, '2024-01-01T00:00:00.000Z')
    })
  })

  describe('fetchAllCVEs', () => {
    it('should be a function with correct parameters', () => {
      // Verify the function exists and has the right signature
      ok(typeof fetchAllCVEs === 'function')
      strictEqual(fetchAllCVEs.length, 3) // Accepts 3 required parameters (2 optional with defaults)
    })

    it('should calculate rate limit delays correctly', () => {
      // Test rate limit calculation logic
      const withApiKey = 600 // 0.6s in ms
      const withoutApiKey = 6000 // 6s in ms
      
      strictEqual(withApiKey, 600)
      strictEqual(withoutApiKey, 6000)
    })

    it('should handle timestamp conversion', () => {
      // Test timestamp to Date conversion
      const timestamp = new Date('2024-01-01').getTime()
      const date = new Date(timestamp)
      ok(date instanceof Date)
      strictEqual(date.toISOString().startsWith('2024-01-01'), true)
    })
  })

  describe('processCVEItem', () => {
    it('should extract all required fields from a valid CVE', () => {
      const mockCVE = {
        cve: {
          id: 'CVE-2024-12345',
          descriptions: [
            { lang: 'en', value: 'Test vulnerability description' }
          ],
          published: '2024-01-15T10:15:00.000',
          metrics: {
            cvssMetricV31: [
              {
                cvssData: {
                  baseScore: 7.5,
                  baseSeverity: 'HIGH'
                }
              }
            ]
          }
        }
      }

      const result = processCVEItem(mockCVE)
      
      ok(result !== null)
      strictEqual(result.id, 'CVE-2024-12345')
      strictEqual(result.description, 'Test vulnerability description')
      strictEqual(result.published, '2024-01-15T10:15:00.000')
      strictEqual(result.severity, 'HIGH')
      strictEqual(result.score, 7.5)
      strictEqual(result.link, 'https://nvd.nist.gov/vuln/detail/CVE-2024-12345')
    })

    it('should handle missing CVSS metrics gracefully', () => {
      const mockCVE = {
        cve: {
          id: 'CVE-2024-99999',
          descriptions: [
            { lang: 'en', value: 'CVE without metrics' }
          ],
          published: '2024-01-15T10:15:00.000'
        }
      }

      const result = processCVEItem(mockCVE)
      
      ok(result !== null)
      strictEqual(result.id, 'CVE-2024-99999')
      strictEqual(result.severity, 'UNKNOWN')
      strictEqual(result.score, null)
    })

    it('should return null for invalid CVE structure', () => {
      const result1 = processCVEItem(null)
      const result2 = processCVEItem({})
      const result3 = processCVEItem({ cve: {} })
      
      strictEqual(result1, null)
      strictEqual(result2, null)
      strictEqual(result3, null)
    })

    it('should handle missing description gracefully', () => {
      const mockCVE = {
        cve: {
          id: 'CVE-2024-88888',
          published: '2024-01-15T10:15:00.000'
        }
      }

      const result = processCVEItem(mockCVE)
      
      ok(result !== null)
      strictEqual(result.description, 'No description available')
    })

    it('should prioritize CVSS v3.1 over other versions', () => {
      const mockCVE = {
        cve: {
          id: 'CVE-2024-77777',
          descriptions: [{ lang: 'en', value: 'Test' }],
          published: '2024-01-15T10:15:00.000',
          metrics: {
            cvssMetricV2: [
              { cvssData: { baseScore: 5.0, baseSeverity: 'MEDIUM' } }
            ],
            cvssMetricV31: [
              { cvssData: { baseScore: 8.5, baseSeverity: 'HIGH' } }
            ]
          }
        }
      }

      const result = processCVEItem(mockCVE)
      
      strictEqual(result.score, 8.5)
      strictEqual(result.severity, 'HIGH')
    })
  })

  describe('formatCVEForFeed', () => {
    it('should format a processed CVE into feed item structure', () => {
      const processedCVE = {
        id: 'CVE-2024-12345',
        description: 'Test vulnerability description',
        published: '2024-01-15T10:15:00.000',
        severity: 'HIGH',
        score: 7.5,
        link: 'https://nvd.nist.gov/vuln/detail/CVE-2024-12345'
      }

      const result = formatCVEForFeed(processedCVE)
      
      ok(result.title.includes('CVE-2024-12345'))
      ok(result.title.includes('Test vulnerability description'))
      ok(result.description.includes('Test vulnerability description'))
      ok(result.description.includes('CVSS Score: 7.5'))
      ok(result.description.includes('HIGH'))
      strictEqual(result.pubDate, '2024-01-15T10:15:00.000')
      strictEqual(result.link, 'https://nvd.nist.gov/vuln/detail/CVE-2024-12345')
      strictEqual(result.guid, 'CVE-2024-12345')
    })

    it('should truncate long descriptions in title', () => {
      const longDescription = 'A'.repeat(150)
      const processedCVE = {
        id: 'CVE-2024-11111',
        description: longDescription,
        published: '2024-01-15T10:15:00.000',
        severity: 'MEDIUM',
        score: 5.0,
        link: 'https://nvd.nist.gov/vuln/detail/CVE-2024-11111'
      }

      const result = formatCVEForFeed(processedCVE)
      
      ok(result.title.length < longDescription.length + 20) // +20 for CVE ID and formatting
      ok(result.title.includes('...'))
    })

    it('should handle CVE without score', () => {
      const processedCVE = {
        id: 'CVE-2024-22222',
        description: 'Test without score',
        published: '2024-01-15T10:15:00.000',
        severity: 'UNKNOWN',
        score: null,
        link: 'https://nvd.nist.gov/vuln/detail/CVE-2024-22222'
      }

      const result = formatCVEForFeed(processedCVE)
      
      ok(result.description.includes('Severity: UNKNOWN'))
      ok(!result.description.includes('CVSS Score'))
    })

    it('should throw error for invalid input', () => {
      let errorThrown = false
      try {
        formatCVEForFeed(null)
      } catch (error) {
        errorThrown = true
        ok(error.message.includes('invalide'))
      }
      ok(errorThrown)
    })
  })
})
